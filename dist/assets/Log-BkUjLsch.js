import{_ as m,i as T,o as a,c as r,n as f,a as l,ab as M,B as E,I as p,t as u,v as $,J as v,D as k,X as B,C as F,y as _,m as h,z as w,F as b,q as y,E as U,u as H,b as z,p as D,d as O}from"./index-DeV2k2bM.js";import{T as R}from"./TopHeader-BOY2n1oO.js";var N='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path d="M0 0h48v48H0z" fill="none"/><path d="M22 4v19.172l-8-8L11.171 18 24 30.828 36.829 18 34 15.172l-8 8V4z"/><path d="M8 44h32c2.206 0 4-1.794 4-4V30h-4v10H8V30H4v10c0 2.206 1.794 4 4 4z"/></svg>';class P extends HTMLElement{connectedCallback(){this.setAttribute("data-shopicon",!0),this.innerHTML=N}}window.customElements.define("shopicon-regular-download",P);const Q={name:"Play",mixins:[T]},j=l("path",{fill:"currentColor",d:"M8 17.175V6.825q0-.425.3-.713t.7-.287q.125 0 .263.037t.262.113l8.15 5.175q.225.15.338.375t.112.475t-.112.475t-.338.375l-8.15 5.175q-.125.075-.262.113T9 18.175q-.4 0-.7-.288t-.3-.712m2-1.825L15.25 12L10 8.65z"},null,-1),J=[j];function X(e,t,s,i,c,o){return a(),r("svg",{style:f(e.svgStyle),viewBox:"0 0 24 24"},J,4)}const G=m(Q,[["render",X]]),K={name:"Record",mixins:[T]},W=l("path",{fill:"currentColor",d:"M12 17q-2.075 0-3.537-1.463T7 12t1.463-3.537T12 7t3.538 1.463T17 12t-1.463 3.538T12 17m8-5q0-1.05-.25-2.025t-.725-1.85q-.2-.375-.162-.8t.387-.675t.775-.15t.625.45q.65 1.125 1 2.388T22 12t-.363 2.675t-1.012 2.4q-.2.35-.612.438t-.763-.163t-.4-.675t.15-.8q.475-.875.738-1.838T20 12m-8-8q-1.075 0-2.037.263T8.125 5q-.375.2-.8.15t-.675-.4t-.162-.763t.437-.612q1.125-.65 2.4-1.012T12 2t2.675.363t2.4 1.012q.375.2.463.613t-.163.762t-.675.4t-.8-.15q-.875-.475-1.85-.737T12 4m-8 8q0 1.075.263 2.038T5 15.875q.2.375.15.8t-.4.675t-.763.163t-.612-.438q-.65-1.125-1.012-2.4T2 12t.35-2.662t1-2.388q.2-.35.625-.45t.775.15t.388.675t-.163.8Q4.5 9 4.25 9.975T4 12m8 8q1.05 0 2.025-.25t1.85-.725q.375-.2.788-.15t.662.4t.163.763t-.438.612q-1.125.65-2.387 1T12 22t-2.662-.35t-2.388-1q-.35-.2-.45-.625t.15-.775t.675-.387t.8.162q.875.475 1.85.725T12 20"},null,-1),Y=[W];function Z(e,t,s,i,c,o){return a(),r("svg",{style:f(e.svgStyle),viewBox:"0 0 24 24"},Y,4)}const ee=m(K,[["render",Z]]),te={name:"MultiSelect",props:{id:String,value:{type:Array,default:()=>[]},options:{type:Array,default:()=>[]},selectAllLabel:String},emits:["open","update:modelValue"],data(){return{internalValue:[...this.value]}},mounted(){this.$refs.dropdown.addEventListener("show.bs.dropdown",this.open)},unmounted(){var e;(e=this.$refs.dropdown)==null||e.removeEventListener("show.bs.dropdown",this.open)},computed:{allOptionsSelected(){return this.internalValue.length===this.options.length},noneSelected(){return this.internalValue.length===0}},watch:{options:{immediate:!0,handler(e){this.value.length===0?this.internalValue=e.map(t=>t.value):this.internalValue=this.internalValue.filter(t=>e.some(s=>s.value===t)),this.$nextTick(()=>{M.getOrCreateInstance(this.$refs.dropdown).update()})}},value:{immediate:!0,handler(e){this.internalValue=e.length===0&&this.options.length>0?this.options.map(t=>t.value):[...e]}},internalValue(e){this.allOptionsSelected||this.noneSelected?this.$emit("update:modelValue",[]):this.$emit("update:modelValue",e)}},methods:{open(){this.$emit("open")},toggleCheckAll(){this.allOptionsSelected?this.internalValue=[]:this.internalValue=this.options.map(e=>e.value)}}},le=["id"],se=["aria-labelledby"],oe={class:"dropdown-item p-0"},ae={class:"form-check px-3 py-2"},ne=["checked"],re={class:"form-check-label"},ie=l("li",null,[l("hr",{class:"dropdown-divider"})],-1),ce=["for"],de=["id","value"],ue={class:"form-check-label"};function he(e,t,s,i,c,o){return a(),r("div",null,[l("button",{class:"form-select text-start text-nowrap",type:"button",id:s.id,"data-bs-toggle":"dropdown","aria-expanded":"false","data-bs-auto-close":"outside"},[E(e.$slots,"default")],8,le),l("ul",{class:"dropdown-menu dropdown-menu-end",ref:"dropdown","aria-labelledby":s.id},[s.selectAllLabel?(a(),r(p,{key:0},[l("li",oe,[l("label",ae,[l("input",{class:"form-check-input ms-0 me-2",type:"checkbox",value:"all",onChange:t[0]||(t[0]=d=>o.toggleCheckAll()),checked:o.allOptionsSelected},null,40,ne),l("div",re,u(s.selectAllLabel),1)])]),ie],64)):$("",!0),(a(!0),r(p,null,v(s.options,d=>(a(),r("li",{key:d.value,class:"dropdown-item p-0"},[l("label",{class:"form-check px-3 py-2 d-flex",for:d.value},[k(l("input",{class:"form-check-input ms-0 me-2",type:"checkbox",id:d.value,value:d.value,"onUpdate:modelValue":t[1]||(t[1]=g=>c.internalValue=g)},null,8,de),[[B,c.internalValue]]),l("div",ue,u(d.name),1)],8,ce)]))),128))],8,se)])}const pe=m(te,[["render",he]]),A=["fatal","error","warn","info","debug","trace"],x="debug",L=1e3,me=new RegExp("\\[.*?\\] (".concat(A.map(e=>e.toUpperCase()).join("|"),")")),ge={name:"Log",components:{TopHeader:R,Play:G,Record:ee,MultiSelect:pe},props:{areas:{type:Array,default:()=>[]},level:{type:String,default:x}},data(){return{lines:[],availableAreas:[],search:"",timeout:null,levels:A,busy:!1}},mounted(){this.startInterval(),this.updateAreas()},unmounted(){this.stopInterval()},computed:{filteredLines(){return this.lines.filter(e=>!this.search||e.toLowerCase().includes(this.search.toLocaleLowerCase()))},lineEntries(){const e=new Map;return this.filteredLines.map(t=>{var o;let s=t.substring(0,50);const i=e.get(s)||0;e.set(s,i+1),s="".concat(s,"-").concat(i+1);const c="log log-".concat(((o=me.exec(t))==null?void 0:o[1].toLowerCase())||"none");return{key:s,className:c,line:t}})},areaOptions(){return this.availableAreas.map(e=>({name:e,value:e}))},areasLabel(){return this.areas.length===0?this.$t("log.areas"):this.areas.length===1?this.areas[0]:this.$t("log.nAreas",{count:this.areas.length})},showMoreButton(){return this.lines.length===L},updateInterval(){var e;return(((e=F.state)==null?void 0:e.interval)||10)*1e3},downloadUrl(){const e=new URLSearchParams;return this.level&&e.append("level",this.level),this.areas.forEach(t=>{e.append("area",t)}),e.append("format","txt"),"./api/system/log?".concat(e.toString())},autoFollow(){return this.timeout!==null}},watch:{selectedAreas(){this.updateLogs()},level(){this.updateLogs()}},methods:{async updateLogs(e){var t;if(!this.busy){try{this.busy=!0;const s=await _.get("/system/log",{params:{level:this.level||null,area:this.areas.length?this.areas:null,count:e?null:L}});this.lines=((t=s.data)==null?void 0:t.result)||[],this.$nextTick(()=>{e?this.scrollToTop():this.scrollToBottom()})}catch(s){console.error(s)}this.busy=!1}},startInterval(){this.stopInterval(),this.updateLogs(),this.timeout=setInterval(()=>{this.updateLogs()},this.updateInterval)},stopInterval(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null)},async updateAreas(){var e;try{const t=await _.get("/system/log/areas");this.availableAreas=((e=t.data)==null?void 0:e.result)||[]}catch(t){console.error(t)}},onScroll(e){this.autoFollow&&e.target.scrollTop+e.target.clientHeight<e.target.scrollHeight&&this.stopInterval()},scrollToTop(){this.$refs.log.scrollTop=0},scrollToBottom(){this.$refs.log.scrollTop=this.$refs.log.scrollHeight},toggleAutoFollow(){this.autoFollow?this.stopInterval():(this.scrollToBottom(),this.startInterval())},updateQuery({level:e,areas:t}){let s=e||this.level,i=t||this.areas;s===x&&(s=void 0),i=i.length?i.join(","):void 0,this.$router.push({query:{level:s,areas:i}})},changeLevel(e){this.updateQuery({level:e.target.value})},changeAreas(e){this.updateQuery({areas:e})}}},V=e=>(D("data-v-1e2e2e2b"),e=e(),O(),e),ve={class:"root safe-area-inset"},fe={class:"container d-flex h-100 flex-column px-0 pb-4"},_e={class:"logs d-flex flex-column overflow-hidden flex-grow-1 px-4 mx-2 mx-sm-4"},we={class:"flex-grow-0 row py-4"},be={class:"col-6 col-lg-3 mb-4 mb-lg-0 d-flex gap-2"},ye={class:"btn-group w-100 w-lg-auto d-flex"},xe={class:"text-nowrap text-truncate"},Le=["aria-label","href"],Te=V(()=>l("shopicon-regular-download",{size:"s",class:"icon"},null,-1)),$e=[Te],ke={class:"col-6 offset-lg-1 col-lg-4 mb-4 mb-lg-0"},Ae=["placeholder"],Ve={class:"filterLevel col-6 col-lg-2"},Se=["aria-label","value"],qe=["value"],Ce={class:"filterAreas col-6 col-lg-2"},Ie=V(()=>l("hr",{class:"my-0"},null,-1)),Me={key:0,class:"my-2"},Ee={key:1,class:"d-block evcc-default-text flex-grow-1","data-testid":"log-content"},Be={key:2,class:"my-4"};function Fe(e,t,s,i,c,o){const d=h("TopHeader"),g=h("Record"),S=h("Play"),q=h("MultiSelect");return a(),r("div",ve,[l("div",fe,[w(d,{title:e.$t("log.title"),class:"mx-4"},null,8,["title"]),l("div",_e,[l("div",we,[l("div",be,[l("div",ye,[l("button",{type:"button",class:b(["btn text-nowrap d-flex gap-2 flex-grow-1 text-nowrap text-truncate",o.autoFollow?"btn-secondary":"btn-outline-secondary"]),onClick:t[0]||(t[0]=(...n)=>o.toggleAutoFollow&&o.toggleAutoFollow(...n))},[l("span",xe,u(e.$t("log.update")),1),o.autoFollow?(a(),y(g,{key:0,ref:"spin",class:"spin flex-shrink-0",style:f({animationDuration:"".concat(o.updateInterval,"ms")})},null,8,["style"])):(a(),y(S,{key:1,class:"flex-shrink-0 play"}))],2),l("a",{class:"btn btn-outline-secondary flex-grow-0","aria-label":e.$t("log.download"),href:o.downloadUrl,download:""},$e,8,Le)])]),l("div",ke,[k(l("input",{type:"search",class:"form-control search",placeholder:e.$t("log.search"),"onUpdate:modelValue":t[1]||(t[1]=n=>c.search=n),"data-testid":"log-search"},null,8,Ae),[[U,c.search]])]),l("div",Ve,[l("select",{class:"form-select","aria-label":e.$t("log.levelLabel"),value:s.level,onInput:t[2]||(t[2]=(...n)=>o.changeLevel&&o.changeLevel(...n))},[(a(!0),r(p,null,v(c.levels,n=>(a(),r("option",{key:n,value:n},u(n.toUpperCase()),9,qe))),128))],40,Se)]),l("div",Ce,[w(q,{id:"logAreasSelect",modelValue:s.areas,options:o.areaOptions,selectAllLabel:e.$t("log.selectAll"),"onUpdate:modelValue":o.changeAreas,onOpen:t[3]||(t[3]=n=>o.updateAreas())},{default:H(()=>[z(u(o.areasLabel),1)]),_:1},8,["modelValue","options","selectAllLabel","onUpdate:modelValue"])])]),Ie,l("div",{class:"overflow-y-scroll pt-2 pb-4 flex-grow-1 d-flex flex-column",ref:"log",onScroll:t[5]||(t[5]=(...n)=>o.onScroll&&o.onScroll(...n))},[o.showMoreButton?(a(),r("div",Me,[l("button",{class:"btn btn-link btn-sm evcc-default-text px-0",type:"button",onClick:t[4]||(t[4]=n=>o.updateLogs(!0))},u(e.$t("log.showAll")),1)])):$("",!0),o.filteredLines.length?(a(),r("code",Ee,[(a(!0),r(p,null,v(o.lineEntries,({line:n,className:C,key:I})=>(a(),r("div",{key:I,class:b(C)},u(n),3))),128))])):(a(),r("p",Be,u(e.$t("log.noResults")),1))],544)])])])}const ze=m(ge,[["render",Fe],["__scopeId","data-v-1e2e2e2b"]]);export{ze as default};
